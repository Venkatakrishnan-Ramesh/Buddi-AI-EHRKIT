<!DOCTYPE article
PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD with MathML3 v1.3 20210610//EN" "JATS-archivearticle1-3-mathml3.dtd">
<article xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:mml="http://www.w3.org/1998/Math/MathML" article-type="research-article" dtd-version="1.3"><?properties open_access?><processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats"><restricted-by>pmc</restricted-by></processing-meta><front><journal-meta><journal-id journal-id-type="nlm-ta">STAR Protoc</journal-id><journal-id journal-id-type="iso-abbrev">STAR Protoc</journal-id><journal-title-group><journal-title>STAR Protocols</journal-title></journal-title-group><issn pub-type="epub">2666-1667</issn><publisher><publisher-name>Elsevier</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="pmc">PMC9440483</article-id><article-id pub-id-type="pii">S2666-1667(22)00527-5</article-id><article-id pub-id-type="doi">10.1016/j.xpro.2022.101647</article-id><article-id pub-id-type="publisher-id">101647</article-id><article-categories><subj-group subj-group-type="heading"><subject>Protocol</subject></subj-group></article-categories><title-group><article-title>Inferring cell communication using single-cell calcium spatiotemporal dynamics</article-title></title-group><contrib-group><contrib contrib-type="author" id="au1"><name><surname>Taghdiri</surname><given-names>Nika</given-names></name><email>ntaghdir@eng.ucsd.edu</email><xref rid="aff1" ref-type="aff">1</xref><xref rid="fn1" ref-type="fn">3</xref><xref rid="cor1" ref-type="corresp">&#x02217;</xref></contrib><contrib contrib-type="author" id="au2"><name><surname>King</surname><given-names>Kevin R.</given-names></name><email>krking@ucsd.edu</email><xref rid="aff1" ref-type="aff">1</xref><xref rid="aff2" ref-type="aff">2</xref><xref rid="fn2" ref-type="fn">4</xref><xref rid="cor2" ref-type="corresp">&#x02217;&#x02217;</xref></contrib><aff id="aff1"><label>1</label>Department of Bioengineering, Jacobs School of Engineering, University of California San Diego, La Jolla, CA, USA</aff><aff id="aff2"><label>2</label>Division of Cardiology and Cardiovascular Institute, Department of Medicine, University of California San Diego, La Jolla, CA, USA</aff></contrib-group><author-notes><corresp id="cor1"><label>&#x02217;</label>Corresponding author <email>ntaghdir@eng.ucsd.edu</email></corresp><corresp id="cor2"><label>&#x02217;&#x02217;</label>Corresponding author <email>krking@ucsd.edu</email></corresp><fn id="fn1"><label>3</label><p id="ntpara0010">Technical contact</p></fn><fn id="fn2"><label>4</label><p id="ntpara0015">Lead contact</p></fn></author-notes><pub-date pub-type="pmc-release"><day>26</day><month>8</month><year>2022</year></pub-date><!-- PMC Release delay is 0 months and 0 days and was based on <pub-date
						pub-type="epub">.--><pub-date pub-type="collection"><day>16</day><month>9</month><year>2022</year></pub-date><pub-date pub-type="epub"><day>26</day><month>8</month><year>2022</year></pub-date><volume>3</volume><issue>3</issue><elocation-id>101647</elocation-id><permissions><copyright-statement>&#x000a9; 2022 The Author(s)</copyright-statement><copyright-year>2022</copyright-year><license><ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbyncndlicense">https://creativecommons.org/licenses/by-nc-nd/4.0/</ali:license_ref><license-p>This is an open access article under the CC BY-NC-ND license (http://creativecommons.org/licenses/by-nc-nd/4.0/).</license-p></license></permissions><abstract id="abs0010"><title>Summary</title><p>There are a limited number of experimental tools for non-destructively discovering cell communication events <italic>in vitro</italic> and <italic>in vivo</italic>. Here, using tissue-specific genetically encoded calcium indicator (GECI) mice, we describe a protocol for preprocessing GECI fluorescence time-series measured by live cell imaging or intravital microscopy, detecting peaks of single-cell calcium fluorescence transients, and inferring putative cell communication events from peak synchrony.</p><p>For complete details on the use and execution of this protocol, please refer to <xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al. (2021)</xref>.</p></abstract><abstract abstract-type="graphical" id="abs0015"><title>Graphical abstract</title><fig id="undfig1" position="anchor"><graphic xlink:href="fx1"/></fig></abstract><abstract abstract-type="author-highlights" id="abs0020"><title>Highlights</title><p><list list-type="simple" id="ulist0010"><list-item id="u0010"><label>&#x02022;</label><p id="p0010">Quantify single-cell calcium dynamics from cell-type-specific reporter cells and mice</p></list-item><list-item id="u0015"><label>&#x02022;</label><p id="p0015">Detect peaks of single-cell calcium transients and convert to binary impulse trains</p></list-item><list-item id="u0020"><label>&#x02022;</label><p id="p0020">Infer putative cell communication from the synchrony of single-cell impulse trains</p></list-item><list-item id="u0025"><label>&#x02022;</label><p id="p0025">Localize putative cell communication events in space and time</p></list-item></list></p></abstract><abstract abstract-type="editor-highlights" id="abs0025"><p>Publisher&#x02019;s note: Undertaking any experimental protocol requires adherence to local institutional guidelines for laboratory safety and ethics.</p></abstract><abstract abstract-type="teaser" id="abs0030"><p>There are a limited number of experimental tools for non-destructively discovering cell communication events <italic>in vitro</italic> and <italic>in vivo</italic>. Here, using tissue-specific genetically encoded calcium indicator (GECI) mice, we describe a protocol for preprocessing GECI fluorescence time-series measured by live cell imaging or intravital microscopy, detecting peaks of single-cell calcium fluorescence transients, and inferring putative cell communication events from peak synchrony.</p></abstract><kwd-group id="kwrds0010"><title>Subject areas</title><kwd>Bioinformatics</kwd><kwd>Cell biology</kwd><kwd>Microscopy</kwd><kwd>Model organisms</kwd><kwd>Molecular biology</kwd><kwd>Signal transduction</kwd></kwd-group></article-meta></front><body><sec id="sec1"><title>Before you begin</title><p id="p0045">Conditional calcium reporter mice are created by crossing mice expressing Cre under the transcriptional regulation of a cell type specific promoter (e.g., Csf1r-Cre, Tie2-Cre, or Alb-Cre to target macrophages, endothelial cells, or hepatocytes respectively) with mice expressing a Cre-inducible GECI (e.g., GFP-calmodulin-M13 peptide (GCaMP)). (<xref rid="bib3" ref-type="bibr">Grienberger and Konnerth, 2012</xref>) <italic>In&#x000a0;vitro</italic> experiments can be performed by isolating, culturing, stimulating, and imaging primary cells in culture. Alternatively, <italic>in vivo</italic> experiments can be performed using disease models and intravital imaging. In this protocol, we describe the computational steps required to transform stacks of time-lapse images with defined single cell ROIs into putative cell communication events based on the spatiotemporal correlations of single cell calcium dynamics (<xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al., 2021</xref>). Before the analysis, one must consider the following:<list list-type="simple" id="olist0010"><list-item id="o0010"><label>1.</label><p id="p0050">The choice of conditional Cre determines the cell type specificity.</p></list-item><list-item id="o0015"><label>2.</label><p id="p0055">The choice of GECI determines the temporal bandwidth, signal strength, background fluorescence, and fluorescence spectrum (<xref rid="bib1" ref-type="bibr">Chen et&#x000a0;al., 2013</xref>).</p></list-item><list-item id="o0020"><label>3.</label><p id="p0060">An incubation system is essential for cell survival during time lapse imaging <italic>in vitro.</italic> To avoid evaporation and to maintain pH, the imaging chamber should be humidified, temperature-controlled at 37&#x000b0;C, and CO<sub>2</sub>-controlled (assuming a bicarbonate buffer is used). If CO<sub>2</sub> is unavailable, a HEPES-based buffer can be used to maintain pH.</p></list-item><list-item id="o0025"><label>4.</label><p id="p0065">One should select a magnification that can spatially resolve single cells so that individual calcium transients can be quantified and putative intercellular communication can be inferred.</p></list-item><list-item id="o0030"><label>5.</label><p id="p0070">Regions for imaging can be chosen to maximize cell density while preserving the ability to discern single cells. This can be accomplished using brightfield images or using a constitutively expressed fluorescence reporter protein that is independent of calcium activity if available (<xref rid="bib2" ref-type="bibr">Gee et&#x000a0;al., 2014</xref>).</p></list-item><list-item id="o0035"><label>6.</label><p id="p0075">Duration of monitoring depends on the biological goals and the frequency of calcium transients in the cell type of interest within the biological context being studied. For investigations of communication in macrophages, we imaged for durations ranging from 5&#x000a0;min to 60&#x000a0;min.</p></list-item><list-item id="o0040"><label>7.</label><p id="p0080">Sampling frequency is a critically important consideration during time-lapse imaging (<xref rid="fig1" ref-type="fig">Figures&#x000a0;1</xref>A and 1B). Undersampling (sampling at intervals longer than the characteristic time scale of calcium transients) should be avoided, as this will blunt or frankly eliminate biologically important signals. (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.1" ref-type="sec">problem 1</xref>).<fig id="fig1"><label>Figure&#x000a0;1</label><caption><p>Example of undersampling and oversampling single-cell calcium transients</p><p>(A) Undersampling at 0.4&#x000a0;Hz (1 sample per 2.5 s) (top) compared to more optimal sampling at 2&#x000a0;Hz (bottom) sacrifices detail about the onset of the calcium transient.</p><p>(B) Oversampling at 15&#x000a0;Hz (top) compared to 2&#x000a0;Hz (bottom) does not obviously improve the signal.</p></caption><graphic xlink:href="gr1"/></fig></p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> In practice, we select optimal sampling frequencies by first oversampling and then digitally downsampling. We then qualitatively compare the pre-downsampled and post-downsampled tracings, evaluating for blunting or elimination of potentially biologically significant signals. If the digitally downsampled signal minimally alters the original signal, then the downsampled frequency is considered adequate as a sampling frequency in future image acquisition experiments. In the specific case of Csf1r<sup>Cre</sup>GCaMP5<sup>fl</sup>, this resulted in an optimal sampling interval of 0.5&#x000a0;s (2&#x000a0;Hz) (<xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al., 2021</xref>). We have not explored the dependencies of optimal sampling interval, but one would expect that it depends on choice of GECI reporter, cell type, and stimulus or biological context. An alternative approach is to determine the bandwidth of the biological signal by collecting a long oversampled recording and performing a Fourier transform to examine the frequency content of the signal. If there is an obvious gap between noise and biological signal, one can sample at twice the maximum biologic frequency in accordance with the Nyquist sampling theorem.</p></disp-quote><list list-type="simple" id="olist0015"><list-item id="o0045"><label>8.</label><p id="p0085">To quantify features of each single cell, one must first define regions of interest (ROI) surrounding each cell and save them to a file (&#x02217;.roi). This can be performed manually by drawing each ROI by hand in Fiji/ImageJ or automatically using CellProfiler and its embedded modules as detailed below.<list list-type="simple" id="olist0020"><list-item id="o0050"><label>a.</label><p id="p0090">To manually define ROIs, open ROI manager in Fiji/ImageJ using <italic>Analyze&#x000a0;&#x0003e;&#x000a0;Tools&#x000a0;&#x0003e;&#x000a0;ROI manager.</italic> Choose <italic>Freehand Selection,</italic> encircle a cell, and select <italic>Add [t].</italic> Additional cells can be encircled and added one by one. Save ROIs using <italic>Analyze&#x000a0;&#x0003e;&#x000a0;Tools&#x000a0;&#x0003e;&#x000a0;ROI manager&#x000a0;&#x0003e;&#x000a0;More&#x000a0;&#x0003e;&#x000a0;Save</italic> (.roi).</p></list-item><list-item id="o0055"><label>b.</label><p id="p0095">To algorithmically define ROIs, we use CellProfiler, as detailed below (<xref rid="bib1" ref-type="bibr">Chen et&#x000a0;al., 2013</xref>; <xref rid="bib4" ref-type="bibr">McQuin et&#x000a0;al., 2018</xref>).<list list-type="simple" id="olist0025"><list-item id="o0060"><label>i.</label><p id="p0100">Download CellProfiler software (macOS or Windows) and open it. You will see 4 preloaded modules at left.</p></list-item><list-item id="o0065"><label>ii.</label><p id="p0105">Drag your image file onto the <italic>Images</italic> module and press <italic>Start Test Mode</italic> (lower left of window).</p></list-item><list-item id="o0070"><label>iii.</label><p id="p0110">In the <italic>Metadata</italic> module, you will be prompted to extract metadata &#x02013; answer yes.</p></list-item><list-item id="o0075"><label>iv.</label><p id="p0115">In <italic>NamesAndTypes</italic>, you will be prompted to create a shorthand name for the image &#x02013; input a shorthand name of your choosing.</p></list-item><list-item id="o0080"><label>v.</label><p id="p0120">In the <italic>Groups</italic> module, you will be asked about grouping images &#x02013; answer no.</p></list-item><list-item id="o0085"><label>vi.</label><p id="p0125">Add 4 modules by clicking&#x000a0;+ to the right of <italic>Adjust modules.</italic> Select the following modules: <italic>Object Processing&#x000a0;&#x0003e;&#x000a0;IdentifyPrimaryObjects, EditObjectsManually, ConvertObjectsToImage, and File Processing&#x000a0;&#x0003e;&#x000a0;SaveImages</italic>.</p></list-item><list-item id="o0090"><label>vii.</label><p id="p0130">Within the <italic>IdentifyPrimaryObjects</italic> module you must answer 3 questions. (1) After Use advanced&#x000a0;settings? select No. (2) Select the shorthand name of your image. (3) Input Typical diameter of object (Min, Max), which can be determined by making interactive measurements. To do this, select the Images module, select Show Selected Image, and select Measure Length in the toolbar. Cells can then be measured interactively to determine minimum and maximum diameters.</p></list-item><list-item id="o0095"><label>viii.</label><p id="p0150">Press <italic>Start Test Mode</italic> (lower left of window) to initiate object segmentation. Object segmentation can be optimized manually using the <italic>EditObjectsManually</italic> module. For additional details, press <italic>Show help</italic> for details. A<italic>dvanced settings</italic> are also available to improve object selection.</p></list-item><list-item id="o0100"><label>ix.</label><p id="p0155">Convert objects to an indexed mask (uint16) using the <italic>ConvertObjectsToImage</italic> module. Export it using the <italic>SaveImages</italic> module (&#x02217;.tiff). Of note, the indexed mask is an image in which pixel values are set to the object number within object boundaries and 0 outside of objects.</p></list-item><list-item id="o0105"><label>x.</label><p id="p0160">Open the indexed mask in Fiji/ImageJ (&#x02217;.tiff).</p></list-item><list-item id="o0110"><label>xi.</label><p id="p0165">Download the custom Fiji/ImageJ macro <bold>IndexedMaskToROI.ijm</bold> from Zenodo (see <xref rid="sec8" ref-type="sec">key resources table</xref>).</p></list-item><list-item id="o0115"><label>xii.</label><p id="p0170">To use the macro, select <italic>Plugins&#x000a0;&#x0003e;&#x000a0;Macros&#x000a0;&#x0003e;&#x000a0;Run.</italic> When prompted, select <bold>IndexedMaskToROI.ijm.</bold> This will create ROIs from the indexed mask.</p></list-item><list-item id="o0120"><label>xiii.</label><p id="p0175">Save ROIs using <italic>Analyze&#x000a0;&#x0003e;&#x000a0;Tools&#x000a0;&#x0003e;&#x000a0;ROI manager&#x000a0;&#x0003e;&#x000a0;More&#x000a0;&#x0003e;&#x000a0;Save</italic> (&#x02217;.roi).</p><p id="p0180">For more information, please visit <ext-link ext-link-type="uri" xlink:href="https://cellprofiler.org/tutorials" id="intref0015">CellProfiler tutorial website</ext-link>.</p></list-item></list></p></list-item></list></p></list-item></list></p><sec id="sec1.1"><title>Institutional permissions</title><p id="p0185">All mouse experiments were approved and conducted under the oversight of University of California San Diego Institutional Animal Care and Use Committee (#17144) or approved by the Subcommittee on Animal Research Care at Massachusetts General Hospital.</p></sec></sec><sec id="sec8"><title>Key resources table</title><p id="p0590">
<table-wrap position="float" id="undtbl1"><table frame="hsides" rules="groups"><thead><tr><th>REGENT or RESOURCE</th><th>SOURCE</th><th>IDENTIFIER</th></tr></thead><tbody><tr><td colspan="3"><bold>Software and algorithms</bold></td></tr><tr><td colspan="3"><hr/></td></tr><tr><td>Fiji/ImageJ</td><td>National Institute of Health, USA (<xref rid="bib6" ref-type="bibr">Schindelin et&#x000a0;al., 2012</xref>)</td><td>RRID: SCR_002285</td></tr><tr><td>MATLAB</td><td>MathWorks- proprietary software</td><td><ext-link ext-link-type="uri" xlink:href="https://www.mathworks.com/downloads/" id="intref0035">R2020a&#x02013; R2021b</ext-link></td></tr><tr><td>Statistics and machine learning toolbox</td><td>MathWorks</td><td><ext-link ext-link-type="uri" xlink:href="https://www.mathworks.com/products/statistics.html" id="intref0040">R2021a -Version 12.1</ext-link></td></tr><tr><td>Signal processing toolbox</td><td>MathWorks</td><td><ext-link ext-link-type="uri" xlink:href="https://www.mathworks.com/products/signal.html" id="intref0045">R2021a -Version 8.6</ext-link></td></tr><tr><td>Bioinformatics toolbox</td><td>MathWorks</td><td><ext-link ext-link-type="uri" xlink:href="https://www.mathworks.com/products/bioinfo.html" id="intref0050">R2021a -Version 4.15.1</ext-link></td></tr><tr><td>CellProfiler</td><td><ext-link ext-link-type="uri" xlink:href="https://cimini-lab.broadinstitute.org/" id="intref0055">Cimini Lab</ext-link>,The Broad Institute of MIT and Harvard</td><td><ext-link ext-link-type="uri" xlink:href="https://cellprofiler.org/releases" id="intref0060">Version 3.1.9</ext-link></td></tr><tr><td colspan="3"><hr/></td></tr><tr><td colspan="3"><bold>Other</bold></td></tr><tr><td colspan="3"><hr/></td></tr><tr><td>Fluoview FV1000 confocal microscope</td><td>Olympus</td><td>FV1000</td></tr><tr><td colspan="3"><hr/></td></tr><tr><td colspan="3"><bold>Deposited data</bold></td></tr><tr><td colspan="3"><hr/></td></tr><tr><td>Raw time lapse images</td><td>Cell Methods paper</td><td><ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1016/j.crmeth.2021.100132" id="intref0065">https://doi.org/10.1016/j.crmeth.2021.100132</ext-link></td></tr><tr><td>Scripts</td><td>GitHub / Zenodo</td><td><ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.6846833" id="intref0070">https://doi.org/10.5281/zenodo.6846833</ext-link></td></tr></tbody></table></table-wrap>
</p></sec><sec id="sec2"><title>Step-by-step method details</title><sec id="sec2.1"><title>Preprocessing of fluorescence time-series image stacks collected from GECI reporter cells</title><p id="p0190">
<disp-quote><p><inline-graphic xlink:href="fx2.gif"/><bold>Timing:&#x000a0;&#x0003c;</bold><bold>30&#x000a0;min</bold></p></disp-quote>
</p><p id="p0195">The Preprocessing Step takes as input, a stack of fluorescence time-lapse images (&#x02217;.tiff) and an associated ROI file (&#x02217;.roi), and generates as output, a list of single cells (one for each ROI) with associated centroids and mean fluorescence time series&#x02019;. Fiji/ImageJ is first used to subtract background fluorescence from each image, extract centroids, and quantify mean fluorescence time series&#x02019; for each single cell (ROI). Next, MATLAB is used to calculate differential fluorescence time series, remove cells without transients, and smooth signals before peak-finding in step 2. Upon completion of this step, the signal is prepared for investigation of spatiotemporal correlations.<list list-type="simple" id="olist0030"><list-item id="o0125"><label>1.</label><p id="p0200">Open the fluorescence time series (&#x02217;.tiff) in Fiji/ImageJ.<list list-type="simple" id="olist0035"><list-item id="o0130"><label>a.</label><p id="p0205">Creating a Median Intensity Projection (MedIP) image.</p></list-item><list-item id="o0135"><label>b.</label><p id="p0210">Subtract it from each frame of the fluorescence time series to remove background fluorescence.</p></list-item></list></p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> Specifically, Image&#x000a0;&#x0003e;&#x000a0;Stacks&#x000a0;&#x0003e;&#x000a0;Z Project&#x000a0;&#x0003e;&#x000a0;Projection type (Median) to create the MedIP image, and Process&#x000a0;&#x0003e;&#x000a0;Image Calculator&#x000a0;&#x0003e;&#x000a0;Image 1 (Raw fluorescence)&#x000a0;&#x0003e;&#x000a0;Subtract&#x000a0;&#x0003e;&#x000a0;Image 2 (MedIP) to subtract the MedIP image (<xref rid="fig2" ref-type="fig">Figures&#x000a0;2</xref> and <xref rid="fig3" ref-type="fig">3</xref>) (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.3" ref-type="sec">problem 2</xref>).</p></disp-quote><list list-type="simple" id="olist0040"><list-item id="o0140"><label>2.</label><p id="p0215">Load the pre-saved ROIs using <italic>Analyze&#x000a0;&#x0003e;&#x000a0;Tools&#x000a0;&#x0003e;&#x000a0;ROI manager&#x0003e; More &#x0003e;Open.</italic><fig id="fig2"><label>Figure&#x000a0;2</label><caption><p>Example of a single-cell calcium transient with and without background fluorescence correction</p><p>afu&#x000a0;= arbitrary fluorescence units.</p></caption><graphic xlink:href="gr2"/></fig><fig id="fig3"><label>Figure&#x000a0;3</label><caption><p>Example of fluorescence time-series preprocessing</p><p>(A) Remove background. Specifically, <italic>Image&#x000a0;&#x0003e;&#x000a0;Stacks&#x000a0;&#x0003e;&#x000a0;Z Project&#x000a0;&#x0003e;&#x000a0;Projection type (Median), Process&#x000a0;&#x0003e;&#x000a0;Image Calculator&#x000a0;&#x0003e;&#x000a0;Image 1 (Raw fluorescence)&#x000a0;&#x0003e;&#x000a0;Subtract&#x000a0;&#x0003e;&#x000a0;Image 2 (MedIP)</italic>.</p><p>(B) Load pre-saved ROIs. Specifically, <italic>Analyze&#x000a0;&#x0003e;&#x000a0;tools&#x000a0;&#x0003e;&#x000a0;ROI manager&#x000a0;&#x0003e;&#x000a0;open</italic>.</p><p>(C) Select quantitative features (e.g., mean gray value, centroid). Specifically, <italic>Analyze&#x000a0;&#x0003e;&#x000a0;set measurement</italic>.</p><p>(D) Record quantitative features for all ROIs. Specifically, <italic>Analyze&#x000a0;&#x0003e;&#x000a0;tools&#x000a0;&#x0003e;&#x000a0;ROI manager&#x000a0;&#x0003e;&#x000a0;More&#x000a0;&#x0003e;&#x000a0;multi measure.</italic></p></caption><graphic xlink:href="gr3"/></fig></p></list-item><list-item id="o0145"><label>3.</label><p id="p0220">Standardize the image orientation by setting the origin (0,0) to the lower left-hand corner using <italic>Image&#x000a0;&#x0003e;&#x000a0;Adjust&#x000a0;&#x0003e;&#x000a0;Coordinates.</italic></p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> A dialog box will appear. Input 0 after Left and 0 after Bottom.</p></disp-quote><list list-type="simple" id="olist0045"><list-item id="o0150"><label>4.</label><p id="p0225">Extract quantitative features (<italic>mean gray value</italic> and <italic>centroid</italic>) across all time points for each ROI using <italic>Analyze&#x000a0;&#x0003e;&#x000a0;Set Measurements&#x000a0;&#x0003e;&#x000a0;Mean Gray Value</italic> and <italic>Centroid</italic> followed by <italic>Analyze&#x000a0;&#x0003e;&#x000a0;Tools&#x000a0;&#x0003e;&#x000a0;ROI</italic> Manager <italic>&#x0003e; More&#x000a0;&#x0003e;&#x000a0;Multi Measure.</italic> Save the resulting file (&#x02217;.csv) (<xref rid="fig3" ref-type="fig">Figure&#x000a0;3</xref>).</p></list-item><list-item id="o0155"><label>5.</label><p id="p0230">Download the cell communication inference script <bold>inferring_cell_communication.m</bold> (<xref rid="sec8" ref-type="sec">key resources table</xref>). Open the script in MATLAB and run it by pressing F5.</p></list-item><list-item id="o0160"><label>6.</label><p id="p0235">The MATLAB script will prompt the user to select a file (choose the .csv file saved above in substep 4).<list list-type="simple" id="olist0050"><list-item id="o0165"><label>a.</label><p id="p0240">The script will automatically calculate <bold>&#x00394;F/F[t]</bold>, a matrix of normalized differential fluorescence time series&#x02019; for each cell.</p></list-item><list-item id="o0170"><label>b.</label><p id="p0245">The script will automatically use <bold>F[t],</bold> a matrix of raw fluorescence values defined at each time point for each cell.</p></list-item><list-item id="o0175"><label>c.</label><p id="p0250">The script will automatically use <bold>F</bold><sub><bold>med</bold></sub>, a vector of median fluorescence values, one for each cell.</p></list-item></list></p></list-item></list><disp-formula id="ufd1"><mml:math id="M1" altimg="si1.gif"><mml:mrow><mml:mrow><mml:mrow><mml:mi>&#x00394;</mml:mi><mml:mtext>F</mml:mtext></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:mtext>F</mml:mtext><mml:mrow><mml:mo>[</mml:mo><mml:mtext>t</mml:mtext><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>F</mml:mtext><mml:mrow><mml:mo>[</mml:mo><mml:mtext>t</mml:mtext><mml:mo>]</mml:mo></mml:mrow><mml:mtext>&#x000a0;</mml:mtext><mml:mo>-</mml:mo><mml:mtext>&#x000a0;</mml:mtext><mml:msub><mml:mtext>F</mml:mtext><mml:mtext>med</mml:mtext></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>/</mml:mo><mml:msub><mml:mtext>F</mml:mtext><mml:mtext>med</mml:mtext></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:math></disp-formula><disp-quote><p><bold><italic>Note:</italic></bold> Use of F<sub>med</sub> as a reference assumes that cells spend at least 50% at baseline. If this assumption is satisfied, then F<sub>med</sub> will provide a good estimate of cell-specific baseline dynamics. If it is only valid during part of the record, one should subset the time series and perform the analysis to derive F<sub>med</sub>. An alternative approach to calculating relative fluorescence is to subtract an estimate of initial fluorescence, F<sub>0</sub>. However, this assumes that cells are not in the midst of a calcium transient at time zero (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.1" ref-type="sec">problem 1</xref>).</p></disp-quote><list list-type="simple" id="olist0055"><list-item id="o0180"><label>7.</label><p id="p0255">The MATLAB script will automatically open <italic>filterDesigner</italic> app, an interactive tool used to design and evaluate digital filters, which will be used to smooth the signal.<list list-type="simple" id="olist0060"><list-item id="o0185"><label>a.</label><p id="p0260">Change the filter type from finite impulse response (FIR) to infinite impulse response IIR. Use the default values or customize the filter for your data.</p></list-item><list-item id="o0190"><label>b.</label><p id="p0265">Select <italic>Design Filter</italic> and export the file using <italic>File&#x000a0;&#x0003e;&#x000a0;Export (to Workspace, as coefficients)</italic> and check the <italic>Overwrite Variables</italic> box.</p></list-item><list-item id="o0195"><label>c.</label><p id="p0270">Close the app. The resulting filter will be automatically applied to the fluorescence time series.</p></list-item><list-item id="o0200"><label>d.</label><p id="p0275">Evaluate adequacy of filtering.<list list-type="simple" id="olist0065"><list-item id="o0205"><label>i.</label><p id="p0280">The script will prompt the user to select an ROI.</p></list-item><list-item id="o0210"><label>ii.</label><p id="p0285">The pre- and post-filtered fluorescence signals will be displayed.</p></list-item><list-item id="o0215"><label>iii.</label><p id="p0290">If satisfied with the result, select &#x0201c;yes&#x0201d;; to reject and redesign the filter, select &#x0201c;no&#x0201d;.</p></list-item><list-item id="o0220"><label>iv.</label><p id="p0295">For more information on <italic>filterDesigner</italic> select <italic>Help</italic> on its dialog box (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.1" ref-type="sec">Problems 1</xref> and <xref rid="sec6.5" ref-type="sec">3</xref>).</p></list-item></list></p></list-item></list></p></list-item></list></p></sec><sec id="sec2.2"><title>Peak finding and impulse train determination from Ca<sup>2+</sup> GECI time-series fluorescence</title><p id="p0300">
<disp-quote><p><inline-graphic xlink:href="fx2.gif"/><bold>Timing: &#x0003c;30&#x000a0;min</bold></p></disp-quote>
<list list-type="simple" id="olist0070"><list-item id="o0225"><label>8.</label><p id="p0305">The MATLAB script will guide the user through a process that identifies peaks in the fluorescence time series&#x02019; and converts them into binary impulse trains for each cell (<xref rid="fig4" ref-type="fig">Figure&#x000a0;4</xref>).<list list-type="simple" id="olist0075"><list-item id="o0230"><label>a.</label><p id="p0310">Input the parameters for the MATLAB function findpeaks, namely threshold, Min peak Height, Min distance between peaks, Min prominence, Min width, and Max width. Default values are suggested.</p></list-item><list-item id="o0235"><label>b.</label><p id="p0315">Evaluate the performance. The MATLAB script displays fluorescence vs time with the identified peaks superimposed for the most active cells.</p></list-item><list-item id="o0240"><label>c.</label><p id="p0320">Accept the peaks by selecting &#x0201c;yes&#x0201d; if they match what one would label manually.</p></list-item><list-item id="o0245"><label>d.</label><p id="p0325">Reject by clicking &#x0201c;no&#x0201d; if there are extra peaks or missed peaks. Then proceed with optimization of parameters (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.1" ref-type="sec">Problems 1</xref> and <xref rid="sec6.7" ref-type="sec">4</xref>).</p></list-item><list-item id="o0250"><label>e.</label><p id="p0330">Optimize peak-finding parameters focusing primarily on Min prominence to adjust for fluorescence amplitude and Min width and Max width to adjust for fluorescence duration.</p></list-item><list-item id="o0255"><label>f.</label><p id="p0335">Once accepted, peaks are automatically transformed into a matrix of binary impulses, B[t], which contains a &#x0201c;1&#x0201d; at the time point of each peak for each cell, and a &#x0201c;0&#x0201d; everywhere else. A histogram of the number of impulses per cell will be automatically displayed. This will be used to fit a probability distribution function and to create synthetic cell impulse trains with the same statistics below.</p></list-item></list><fig id="fig4"><label>Figure&#x000a0;4</label><caption><p>Generation of a single-cell binary impulse train from the normalized differential fluorescence time-series of a single ROI</p><p>Normalized differential fluorescence time series&#x02019; are low pass filtered, subjected to peak-finding, and converted to single cell binary impulse trains. Figure&#x000a0;reprinted with permission from <xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al. (2021)</xref>.</p></caption><graphic xlink:href="gr4"/></fig></p></list-item></list>
<disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> Optimization of peak-finding parameters is critical because fluorescence kinetics and amplitudes different across experimental systems since they depend on many factors including cell type, microenvironmental context, and choice of genetically encoded calcium reporter.</p></disp-quote>
</p></sec><sec id="sec2.3"><title>Inference of cell communication pipeline based on &#x0201c;excess synchrony&#x0201d; metric</title><p id="p0340">
<disp-quote><p><inline-graphic xlink:href="fx2.gif"/><bold>Timing: &#x0223c;1 h</bold></p></disp-quote>
</p><p id="p0345">Step 3 of this protocol infers putative cell communication events from the spatiotemporal synchrony of single cell calcium impulse trains. The strategy is illustrated in <xref rid="fig5" ref-type="fig">Figure&#x000a0;5</xref>. An overview of the logic and approach are presented first, followed by the detailed sub-steps.<fig id="fig5"><label>Figure&#x000a0;5</label><caption><p>Diagram of cell communication pipeline inference steps</p><p>(A&#x02013;C) (A) &#x0201c;Real&#x0201d; experimental binary impulse trains are (B)&#x000a0;modeled based on their impulse train statistics to create (C) &#x0201c;generated&#x0201d; binary impulse trains.</p><p>(D&#x02013;F) Real and generated impulse trains are independently used to calculate synchrony, S (w, <bold>&#x003c4;</bold>), specifically (E/F) S<sub>real</sub> (w, <bold>&#x003c4;</bold>) and S<sub>gen</sub> (w, <bold>&#x003c4;</bold>).</p><p>(G) A threshold called S<sub>th</sub> is defined based on generated synchrony and a user-generated z score.</p><p>(H) Excess synchrony, &#x00394;S/w.</p><p>(I and J) Cell communication events are identified at time <bold>&#x003c4;</bold><sub>comm</sub>&#x02019;s and spatial locations (X<sub>comm</sub>&#x02019;s, Y<sub>comm</sub>&#x02019;s). Figure&#x000a0;reprinted with permission from <xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al. (2021)</xref>.</p></caption><graphic xlink:href="gr5"/></fig></p><p id="p0350">For purposes of this protocol, synchrony, <bold>S (w, &#x003c4;)</bold>, is defined as the number of impulses within a time window of length <bold>w</bold>, beginning at time <bold>&#x003c4;</bold>. Synchronous impulses can occur either because of true biological information transfer or simply because of chance. By first modeling the &#x0201c;chance&#x0201d; component, we can then limit our search for cell communication to those times during which the experimentally observed synchrony exceeds the amount of synchrony expected &#x0201c;by chance&#x0201d;. We call the difference, after normalization to window size, &#x0201c;excess synchrony&#x0201d;, <bold>&#x00394;S/w</bold>.<disp-quote><p><bold><italic>Note:</italic></bold> The reason for normalizing is because synchrony increases monotonically with window size. Normalizing to w enables comparison of excess synchrony across different window sizes.</p></disp-quote></p><p id="p0355">To determine the synchrony expected by chance, we model the statistics of experimental impulse trains from &#x0201c;real cells&#x0201d;, fit it to a probability distribution, and then sample the distribution to create generated impulse trains from &#x0201c;generated cells&#x0201d; having the same statistics. This allows calculation of generated synchrony due to chance alone, <bold>S</bold><sub><bold>gen</bold></sub>
<bold>(w, &#x003c4;)</bold>. To convert generated synchrony into a single number that can be easily subtracted from real experimentally observed synchrony, <bold>S</bold><sub><bold>real</bold></sub>
<bold>(w, &#x003c4;)</bold>, to calculate excess synchrony, we define a threshold, <bold>S</bold><sub><bold>th</bold></sub>, at a specified percentile of <bold>S</bold><sub><bold>gen</bold></sub>
<bold>(w, &#x003c4;)</bold> using a <bold>z score</bold>. Excess synchrony, <bold>&#x00394;S/w</bold>, is then calculated by subtracting <bold>S</bold><sub><bold>real</bold></sub>
<bold>(w, &#x003c4;)</bold> and <bold>S</bold><sub><bold>th</bold></sub> and normalizing to <bold>w</bold>. Selection of <bold>S</bold><sub><bold>th</bold></sub> via the choice of z score is a critical step because high <bold>S</bold><sub><bold>th</bold></sub> values will predict few cell communication events but have fewer false positives than low <bold>S</bold><sub><bold>th</bold></sub> values, which will predict more cell communication events but include more false positives (predicted communication where synchrony is actually due to chance alone).</p><p id="p0360">To determine the timing of putative cell communication events we derive a vector of communication times <bold>&#x003c4;</bold><sub><bold>comm</bold></sub> by grouping nearby values of <bold>&#x003c4;</bold> for which excess synchrony <bold>&#x00394;S/w</bold> is greater than zero. For each <bold>&#x003c4;</bold><sub><bold>comm</bold></sub>, spatial analysis is limited to only those cells with calcium impulses between &#x003c4;<sub><bold>comm</bold></sub> and <bold>&#x003c4;</bold><sub><bold>comm</bold></sub>&#x000a0;+ <bold>w</bold>. k-Means clustering is performed and the centroid of the cluster with the greatest cell density is taken as the location of putative cell communication <bold>X</bold><sub><bold>comm</bold></sub>, <bold>Y</bold><sub><bold>comm</bold></sub>. The results of putative cell communication events and their component cells are reported in tabular form in a single &#x02217;.csv file. The following describes detailed sub steps with a focus on the how the user interacts with the script.<list list-type="simple" id="olist0080"><list-item id="o0260"><label>9.</label><p id="p0365">The MATLAB script will automatically open the interactive <italic>distributionFitter</italic> app to facilitate fitting a probability distribution function to the experimental impulse frequencies (<xref rid="fig6" ref-type="fig">Figure&#x000a0;6</xref>).<list list-type="simple" id="olist0085"><list-item id="o0265"><label>a.</label><p id="p0370">In the parent window, select the <italic>Data</italic> tab and a daughter window will open.</p></list-item><list-item id="o0270"><label>b.</label><p id="p0375">In the Data field of the daughter window, enter &#x0201c;ImpulseHistogram&#x0201d;, and then select <italic>Create Data Set.</italic></p></list-item><list-item id="o0275"><label>c.</label><p id="p0380">Returning to the parent window, select the <italic>NewFit&#x02026;</italic> tab, which will open a new daughter window.</p></list-item><list-item id="o0280"><label>d.</label><p id="p0385">In the <italic>Data</italic> field of the new daughter window, select &#x0201c;ImpulseHistogram&#x0201d;.</p></list-item><list-item id="o0285"><label>e.</label><p id="p0390">In the <italic>Distribution</italic> field, select &#x0201c;negative binomial&#x0201d;.</p></list-item><list-item id="o0290"><label>f.</label><p id="p0395">Finally, select <italic>Apply</italic> to create the probability distribution object and select <italic>Save to Workspace to</italic> save it.</p></list-item><list-item id="o0295"><label>g.</label><p id="p0400">Close the app.<list list-type="simple" id="olist0090"><list-item id="o0300"><label>i.</label><p id="p0405">The MATLAB script will perform a Chi square goodness of fit test using the built-in function <italic>chi2gof.</italic></p></list-item><list-item id="o0305"><label>ii.</label><p id="p0410">The MATLAB script will return a test decision for the null hypothesis that the experimental impulse histogram data comes from the specified probability distribution (selected from a dropdown in 9e).</p></list-item><list-item id="o0310"><label>iii.</label><p id="p0415">If the test decision rejects the null hypothesis at the 5% significance level, then the app will reopen.</p></list-item><list-item id="o0315"><label>iv.</label><p id="p0420">9a&#x02013;f must be repeated with a different distribution.</p></list-item><list-item id="o0320"><label>v.</label><p id="p0425">Alternatively, the MATLAB script will proceed to automatically generate synthetic cell impulse trains by sampling from the approved distribution and placing the impulses at random time points. Therefore, the synchrony of resulting generated data will be normally distributed.</p></list-item></list></p></list-item></list><fig id="fig6"><label>Figure&#x000a0;6</label><caption><p>Modeling experimental impulse train statistics to generate synthetic cell impulse trains</p></caption><graphic xlink:href="gr6"/></fig></p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> The script will run automatically with the assistance of only two input parameters - <italic>window&#x000a0;size,</italic> which determines temporal resolution, and a <italic>z-score,</italic> which determines the inclusiveness or exclusiveness of communication inference (default values are provided for both).</p></disp-quote><list list-type="simple" id="olist0095"><list-item id="o0325"><label>10.</label><p id="p0430">The user will be prompted, &#x0201c;<italic>Do you want to choose the window size automatically?&#x0201d;</italic> To use the default window size or specify it manually, answer &#x0201c;no.&#x0201d; Alternatively, to perform a systematic comparison of window sizes in search of the one yielding the maximum excess synchrony, answer &#x0201c;yes&#x0201d; (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.9" ref-type="sec">problem 5</xref>).</p></list-item><list-item id="o0330"><label>11.</label><p id="p0435">The user will be prompted to enter a z score, <bold>z</bold>, (a default is provided), which will be combined with the normally distributed generated data of mean <bold>&#x003bc;</bold> and standard deviation <bold>&#x003c3;</bold> to give a threshold synchrony <bold>S</bold><sub><bold>th</bold></sub> (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.9" ref-type="sec">problem 5</xref>).</p></list-item></list><disp-formula id="ufd2"><mml:math id="M2" altimg="si2.gif"><mml:mrow><mml:msub><mml:mtext>S</mml:mtext><mml:mtext>th</mml:mtext></mml:msub><mml:mtext>&#x000a0;</mml:mtext><mml:mo linebreak="badbreak">=</mml:mo><mml:mtext>&#x003bc;&#x000a0;</mml:mtext><mml:mo linebreak="goodbreak">+</mml:mo><mml:mtext>&#x000a0;z&#x02217;</mml:mtext><mml:mi>&#x003c3;</mml:mi></mml:mrow></mml:math></disp-formula><disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> Optimization of the z score is critical. The default z score is set at 1.28, the 80<sup>th</sup> percentile. However, S<sub>th</sub> is a tunable parameter, which allows the user to alter the stringency of this threshold. At lower percentiles (lower S<sub>th</sub> values), the number of identified peaks will increase, resulting in more predicted events but more false positives (i.e., more synchronous impulses that are labeled communication will actually be due to chance). Conversely, at higher percentiles (higher S<sub>th</sub> values), the number of identified peaks will decrease resulting in fewer predicted events but more risk of false negatives (i.e., missing true communication events). The z score should be optimized to balance the competing goals of maximizing the number of events detected (by lowering the z score) while minimizing the number of false positives (by increasing the z score). In practice, if one has a biologically negative control sample (i.e., few calcium transients per time) one can reduce the z score until an unacceptable number of cell communication events (of which all are considered false positives) are detected.</p></disp-quote><list list-type="simple" id="olist0100"><list-item id="o0335"><label>12.</label><p id="p0440">The MATLAB script will calculate Excess Synchrony <bold>&#x00394;S/w</bold> is calculated (<xref rid="fig7" ref-type="fig">Figure&#x000a0;7</xref>).<fig id="fig7"><label>Figure&#x000a0;7</label><caption><p>Determination of real and generated synchrony from single-cell impulse trains</p><p>Synchrony is defined as the sum of impulses within a window of length w beginning at time <bold>&#x003c4;</bold>. &#x0201c;Real&#x0201d; synchrony S<sub>real</sub> derives from real experimental single impulse trains. &#x0201c;Gen&#x0201d; synchrony S<sub>gen</sub> derives from generated single impulse trains. Excess synchrony is shown without normalization &#x00394;S. Figure&#x000a0;reprinted with permission from <xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al. (2021)</xref>.</p></caption><graphic xlink:href="gr7"/></fig></p></list-item></list><disp-formula id="ufd3"><mml:math id="M3" altimg="si3.gif"><mml:mrow><mml:mtext>&#x000a0;</mml:mtext><mml:mrow><mml:mrow><mml:mi>&#x00394;</mml:mi><mml:mtext>S</mml:mtext></mml:mrow><mml:mo>/</mml:mo><mml:mtext>w</mml:mtext></mml:mrow><mml:mo linebreak="badbreak">=</mml:mo><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mtext>S</mml:mtext><mml:mtext>real</mml:mtext></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mtext>w,&#x000a0;&#x003c4;</mml:mtext><mml:mo>)</mml:mo></mml:mrow><mml:mo>-</mml:mo><mml:mtext>&#x000a0;</mml:mtext><mml:msub><mml:mtext>S</mml:mtext><mml:mtext>th</mml:mtext></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>/</mml:mo><mml:mtext>w</mml:mtext></mml:mrow></mml:mrow></mml:math></disp-formula><list list-type="simple" id="olist0105"><list-item id="o0340"><label>13.</label><p id="p0445">The MATLAB script will return the timing of putative cell communication events which is vector of communication times <bold>&#x003c4;</bold><sub><bold>comm</bold></sub> by grouping nearby values of <bold>&#x003c4;</bold> for which excess synchrony <bold>&#x00394;S/w</bold> is greater than zero (<xref rid="fig8" ref-type="fig">Figure&#x000a0;8</xref>).<fig id="fig8"><label>Figure&#x000a0;8</label><caption><p>Example of how varying S<sub>th</sub> affects predicted cell communication events</p><p>S<sub>th</sub> corresponding to the 50<sup>th</sup>, 80<sup>th</sup>, and 100<sup>th</sup> percentiles of S<sub>gen</sub> are illustrated. Communication is predicted where S<sub>real</sub> exceeds S<sub>th</sub>, (e.g., where excess synchrony is greater than zero). The initiation of each putative communication event where S<sub>real</sub> sustainably exceeds S<sub>th</sub> is deemed a putative communication event assigned to the start time <bold>&#x003c4;</bold><sub>comm</sub>. Figure&#x000a0;reprinted with permission from <xref rid="bib7" ref-type="bibr">Taghdiri et&#x000a0;al. (2021)</xref>.</p></caption><graphic xlink:href="gr8"/></fig></p></list-item><list-item id="o0345"><label>14.</label><p id="p0450">The script will open a window prompting the user to select a criterion for unsupervised learning algorithm that is used to solve clustering problems.</p></list-item><list-item id="o0350"><label>15.</label><p id="p0455">The script will calculate an optimal number of clusters k, <italic>evalclusters.</italic></p></list-item><list-item id="o0355"><label>16.</label><p id="p0460">The script will use optimal k to preform perform k-Means clustering, <italic>kmeans</italic> function in MATLAB (See <xref rid="sec6" ref-type="sec">troubleshooting</xref>, <xref rid="sec6.11" ref-type="sec">problem 6</xref>).</p></list-item><list-item id="o0360"><label>17.</label><p id="p0465">The script will return <bold>&#x003c4;</bold><sub><bold>comm</bold></sub> and perform spatial analysis on only those cells with calcium impulses between <bold>&#x003c4;</bold><sub><bold>comm</bold></sub> and <bold>&#x003c4;</bold><sub><bold>comm</bold></sub>&#x000a0;+ <bold>w.</bold> Then the script will preform k-Means clustering and report the centroid of the cluster with the greatest cell density as the location for putative cell communication <bold>X</bold><sub><bold>comm</bold></sub>, <bold>Y</bold><sub><bold>comm</bold></sub> (<xref rid="fig9" ref-type="fig">Figure&#x000a0;9</xref>).<fig id="fig9"><label>Figure&#x000a0;9</label><caption><p>Finding high spatiotemporal synchronous cells</p><p>Plot of cluster density vs cluster number for a single communication event (left). Cells with impulses in the time interval between <bold>&#x003c4;</bold><sub>comm</sub> and <bold>&#x003c4;</bold><sub>comm</sub>&#x000a0;+ w are subjected to k-Means clustering (right). The centroid of the cluster with the maximum density is interpreted as the location of putative communication (right).</p></caption><graphic xlink:href="gr9"/></fig><fig id="fig10"><label>Figure&#x000a0;10</label><caption><p>Example of the output folder contents at analysis completion</p><p>The folder includes an output file, FinalResults.csv, and associated plots.</p></caption><graphic xlink:href="gr10"/></fig></p></list-item><list-item id="o0365"><label>18.</label><p id="p0470">Upon completion the script will create an output file called <bold>FinalResults.csv</bold> and save all associated plots and figures. The FinalResults file contains a &#x02217;.csv file with the following column headings: EventIndex, StartTime, EndTime, Duration, NumOfCells, CellIndex, CentroidX, CentroidY.</p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> For clarity, each row refers to a distinct cell and its participation in each cell communication event. Therefore, EventIndex StartTime, EndTime, Duration, Number of Cells are properties of the event, while CellIndex, CentroidX, CentroidY are defined for the individual cells within each event (<xref rid="fig10" ref-type="fig">Figure&#x000a0;10</xref>).</p></disp-quote></p></sec></sec><sec id="sec3"><title>Expected outcomes</title><p id="p0475">This protocol describes an imaging-based method for quantifying single cell calcium reporter responses and inferring cell communication based on &#x0201c;Excess Synchrony&#x0201d;. A computational pipeline analyzes the images and creates a list of putative cell communication events with associated timing, location, and component cells. This can then be studied using genetic or pharmacologic modulators of specific cell communication mechanisms to validate and probe mechanism via perturbation. The protocol is best suited for investigators with basic signal processing and computational experience and who have access to time-lapse fluorescence recordings of cells that are potentially communicating.</p></sec><sec id="sec4"><title>Quantification and statistical analysis</title><p id="p0480">Quantification and statistical analyses are described throughout the protocol.</p></sec><sec id="sec5"><title>Limitations</title><p id="p0485">A limitation of our study is that we lack gold standard methods to validate whether correlated dynamics are indeed the result of cell communication. Some of our studies <italic>In&#x000a0;vivo</italic> show spatially isolated communication events where propagation of calcium dynamics is evident by inspection. However, in other experiments where calcium reporters are highly dynamic and densely packed in tissue, it is difficult to confirm. Application of mutual information theory and causal inference may be helpful for determining whether correlated calcium dynamics are cell autonomous or are the result of cell-to-cell or environment-to-cell communication (<xref rid="bib5" ref-type="bibr">Quinn et&#x000a0;al., 2011</xref>; <xref rid="bib8" ref-type="bibr">Wibral et&#x000a0;al., 2013</xref>). The computational pipeline is applicable to fluorescence live cell time series imaging with high cell density. However, a dense and very active population would degrade the confidence to find the high spatiotemporal cells as a putative cell communication using k-Means clustering. A&#x000a0;second important limitation is that our method cannot distinguish information transfer between cells from information transfer from the environment to neighboring cells (an external stimulus). An important assumption in the current instantiation is that there is only one event per time point within one field of view. To accommodate cases where the density and frequency of cell communication is high, one can separate the image into sub-images and run the pipeline on each sub-image. In this way, one can discover simultaneous but spatially distinct cell communication events within the same field of view.</p></sec><sec id="sec6"><title>Troubleshooting</title><sec id="sec6.1"><title>Problem 1</title><p id="p0490">Fewer than expected binary impulses are observed when compared to visual inspection of the fluorescence time lapse images or the resulting raw fluorescence tracings (step 6, <xref rid="sec1" ref-type="sec">before you begin</xref> and step 7 <xref rid="sec2" ref-type="sec">step-by-step method details</xref>).</p></sec><sec id="sec6.2"><title>Potential solution</title><p id="p0495">
<list list-type="simple" id="ulist0015"><list-item id="u0030"><label>&#x02022;</label><p id="p0500">If no calcium transients are observed, confirm the presence of Cre and GECI reporter genes by genotyping the mouse.</p></list-item><list-item id="u0035"><label>&#x02022;</label><p id="p0505">Calcium transients may be unappreciated if their amplitudes are too low. If the background-corrected-amplitude is low compared to the noise, or only uses a small portion of the available dynamic range, increase the excitation source or the gain of the detector. We recommend maximizing the amplitude until your maximum biological signal of interest is near saturation. To minimize background, use phenol-red free medium and reduce other sources of autofluorescence.</p></list-item><list-item id="u0040"><label>&#x02022;</label><p id="p0510">Image normalization can cause some calcium transients to be reduced in amplitude if the reference fluorescence is too high. A potential solution is to change the reference from median to initial fluorescence. Alternatively, one can reference to the median or initial fluorescence of a subset of the time-series that contains more characteristic cellular calcium responses.</p></list-item><list-item id="u0045"><label>&#x02022;</label><p id="p0515">If the calcium transients appear blunted or if one perceives some are missing, it is possible the signal is undersampled. This is solvable by increasing the sampling rate during image acquisition. Alternatively, blunted, or missing transients may be the result of overfiltering, in which case, the user should increase the passband frequency during the digital filter design substep in order to preserve more signal detail. For more information on optimization of digital filters in MATLAB, please refer to the documentation for the function <ext-link ext-link-type="uri" xlink:href="https://www.mathworks.com/help/signal/ref/designfilt.html" id="intref0020">designfilt</ext-link>. Missing transients may also result from inadequate optimization of the <italic>findpeaks</italic> function above.</p></list-item><list-item id="u0050"><label>&#x02022;</label><p id="p0520">If the cell type has not been characterized before, it is possible the cell type does not exhibit calcium transients in the biological and experimental context being tested. In this case, consider different stimuli, different culture media, or different time points for analysis. In&#x000a0;vivo, consider modifying the disease model the time points analyzed.</p></list-item></list>
</p></sec><sec id="sec6.3"><title>Problem 2</title><p id="p0525">The background fluorescence is steadily decreasing during calcium transient imaging due to photobleaching (step 1 <xref rid="sec2" ref-type="sec">step-by-step method details</xref>).</p></sec><sec id="sec6.4"><title>Potential solution</title><p id="p0530">Instead of subtracting a constant median fluorescence from each time point (step 1 and <xref rid="fig3" ref-type="fig">Figure&#x000a0;3</xref>), one can remove dynamic background fluorescence by subtracting a windowed moving mean of the background fluorescence using the <italic>movmean</italic> function in MATLAB.</p></sec><sec id="sec6.5"><title>Problem 3</title><p id="p0535">The signal is overly smooth after digital filtering (step 7 <xref rid="sec2" ref-type="sec">step-by-step method details</xref>).</p></sec><sec id="sec6.6"><title>Potential solution</title><p id="p0540">Increase the lowpass filter passband frequency during filter design to preserve more signal detail if there are concerns that potentially important biological signals were removed during filtering. Reanalyze the pre- and post-filtered signals to confirm improvement.</p></sec><sec id="sec6.7"><title>Problem 4</title><p id="p0545">More peaks are identified by the <italic>findpeaks</italic> function than one would expect from visual inspection of the fluorescence time series (step 8 <xref rid="sec2" ref-type="sec">step-by-step method details</xref>).</p></sec><sec id="sec6.8"><title>Potential solution</title><p id="p0550">Change default parameters within the <italic>findpeaks</italic> function to alter the identified peaks and the location of impulses. The <italic>findpeaks</italic> function in MATLAB accepts six parameters, <italic>MinPeakHeight, MinPeakWidth, MaxPeakWidth, Threshold</italic> (the minimum height differences between adjacent peaks), <italic>MinProminence</italic>, and <italic>MinDistPeak</italic> (<xref rid="fig11" ref-type="fig">Figure&#x000a0;11</xref>). To optimize peak-finding focus primarily on <italic>Min prominence</italic> to adjust for fluorescence amplitude and <italic>Min width</italic> and <italic>Max width</italic> to adjust for fluorescence duration.<fig id="fig11"><label>Figure&#x000a0;11</label><caption><p>Example of peak finding optimization</p><p>(A) Peaks identified using <italic>findpeaks</italic> with default parameters suggested by MATLAB.</p><p>(B) Peaks identified using <italic>findpeaks</italic> with optimized parameters suggested by inferring cell communication pipeline. Please refer to <ext-link ext-link-type="uri" xlink:href="https://www.mathworks.com/help/signal/ref/findpeaks.html" id="intref0075">findpeaks</ext-link> function documentation in MATLAB if you want to adjust the parameters.</p></caption><graphic xlink:href="gr11"/></fig></p></sec><sec id="sec6.9"><title>Problem 5</title><p id="p0555">The predicted number of cell communication events are much greater or far fewer than the expected number of events (steps 10 and 11 <xref rid="sec2" ref-type="sec">step-by-step method details</xref>).</p></sec><sec id="sec6.10"><title>Potential solution</title><p id="p0560">Reduce the z score, <bold>z</bold>, which will decrease <bold>S</bold><sub><bold>th</bold></sub>, and increase <bold>&#x00394;S/w</bold> (<xref rid="fig8" ref-type="fig">Figure&#x000a0;8</xref>). This will result in more inclusive and less stringent criteria, which will predict more cell communication events but be more susceptible to including more synchrony that merely occurs by chance. Conversely, increasing the <bold>z</bold> will increase <bold>S</bold><sub><bold>th</bold></sub>, and decrease <bold>&#x00394;S/w</bold>. This will result in a more restrictive and more stringent criteria, which will predict fewer cell communication events but be more susceptible to erroneously missing true cell communication events.</p><p id="p0565">The window size, <bold>w</bold>, plays a critical role in distinguishing between calcium impulses that are due to cell communication and those that occur by chance. The pipeline optimizes it algorithmically by evaluating the maximum excess synchrony <bold>&#x00394;S/w</bold> for all values of <bold>w</bold> and selecting the window size that yields a local maximum with additional constraints on minimum and maximum values (<xref rid="fig12" ref-type="fig">Figure&#x000a0;12</xref>). Choose algorithmic window size optimization by answering &#x0201c;yes&#x0201d; when asked. Of note, this may either increase or decrease the number of communication events and the number of cells involved in each event.<fig id="fig12"><label>Figure&#x000a0;12</label><caption><p>Algorithmic determination of the optimal window size, w</p><p>The optimal window size is taken to be the global maximum excess synchrony. However, we reject window sizes shorter than the average single cell calcium transient.</p></caption><graphic xlink:href="gr12"/></fig></p></sec><sec id="sec6.11"><title>Problem 6</title><p id="p0570">Cells predicted to be synchronous appear spatially disperse rather than localized or are predicted in unexpected locations (step 14 <xref rid="sec2" ref-type="sec">step-by-step method details</xref>).</p></sec><sec id="sec6.12"><title>Potential solution</title><p id="p0575">Once the cells are selected, spatial clustering is performed algorithmically using k-Means clustering without regard for the timing of calcium transients. The optimal k value is determined using the MATLAB function <italic>evalclusters,</italic> which allows for different clustering evaluation criterion &#x02013; <italic>silouette</italic> (default), <italic>gap</italic>, <italic>CalinskiHarabasz</italic>, or <italic>DaviesBouldin</italic>. The MATLAB script exposes this option to the user can compare clustering results for different criterion if the default does not yield expected or intuitive results. Finally, if a technical explanation is not uncovered, a biological explanation may also be possible. For example, it is possible that distant cells are communicating across seemingly long distances via fine processes.</p></sec></sec><sec id="sec7"><title>Resource availability</title><sec id="sec7.1"><title>Lead contact</title><p id="p0580">Further information and requests for resources and reagents should be directed to and will be fulfilled by the lead contact, Kevin.R. King (<ext-link ext-link-type="uri" xlink:href="mailto:krking@ucsd.edu" id="intref0025">krking@ucsd.edu</ext-link>).</p></sec><sec id="sec7.2"><title>Materials availability</title><p id="p0585">All unique/stable reagents generated in this study are available from the <xref rid="sec7.1" ref-type="sec">lead contact</xref> without restriction. Further information and requests for resources and reagents should be directed to and will be fulfilled by the <xref rid="sec7.1" ref-type="sec">lead contact</xref> Kevin.R. King (<ext-link ext-link-type="uri" xlink:href="mailto:krking@ucsd.edu" id="intref0030">krking@ucsd.edu</ext-link>).</p></sec></sec></body><back><ref-list id="cebib0010"><title>References</title><ref id="bib1"><element-citation publication-type="journal" id="sref1"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>T.W.</given-names></name><name><surname>Wardill</surname><given-names>T.J.</given-names></name><name><surname>Sun</surname><given-names>Y.</given-names></name><name><surname>Pulver</surname><given-names>S.R.</given-names></name><name><surname>Renninger</surname><given-names>S.L.</given-names></name><name><surname>Baohan</surname><given-names>A.</given-names></name><name><surname>Schreiter</surname><given-names>E.R.</given-names></name><name><surname>Kerr</surname><given-names>R.A.</given-names></name><name><surname>Orger</surname><given-names>M.B.</given-names></name><name><surname>Jayaraman</surname><given-names>V.</given-names></name><etal/></person-group><article-title>Ultrasensitive fluorescent proteins for imaging neuronal activity</article-title><source>Nature</source><volume>499</volume><year>2013</year><fpage>295</fpage><lpage>300</lpage><pub-id pub-id-type="pmid">23868258</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal" id="sref2"><person-group person-group-type="author"><name><surname>Gee</surname><given-names>J.M.</given-names></name><name><surname>Smith</surname><given-names>N.A.</given-names></name><name><surname>Fernandez</surname><given-names>F.R.</given-names></name><name><surname>Economo</surname><given-names>M.N.</given-names></name><name><surname>Brunert</surname><given-names>D.</given-names></name><name><surname>Rothermel</surname><given-names>M.</given-names></name><name><surname>Morris</surname><given-names>S.C.</given-names></name><name><surname>Talbot</surname><given-names>A.</given-names></name><name><surname>Palumbos</surname><given-names>S.</given-names></name><name><surname>Ichida</surname><given-names>J.M.</given-names></name><etal/></person-group><article-title>Imaging activity in neurons and glia with a Polr2a-based and cre-dependent GCaMP5G-IRES-tdTomato reporter mouse</article-title><source>Neuron</source><volume>83</volume><year>2014</year><fpage>1058</fpage><lpage>1072</lpage><pub-id pub-id-type="pmid">25155958</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal" id="sref3"><person-group person-group-type="author"><name><surname>Grienberger</surname><given-names>C.</given-names></name><name><surname>Konnerth</surname><given-names>A.</given-names></name></person-group><article-title>Imaging calcium in neurons</article-title><source>Neuron</source><volume>73</volume><year>2012</year><fpage>862</fpage><lpage>885</lpage><pub-id pub-id-type="pmid">22405199</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal" id="sref4"><person-group person-group-type="author"><name><surname>McQuin</surname><given-names>C.</given-names></name><name><surname>Goodman</surname><given-names>A.</given-names></name><name><surname>Chernyshev</surname><given-names>V.</given-names></name><name><surname>Kamentsky</surname><given-names>L.</given-names></name><name><surname>Cimini</surname><given-names>B.A.</given-names></name><name><surname>Karhohs</surname><given-names>K.W.</given-names></name><name><surname>Doan</surname><given-names>M.</given-names></name><name><surname>Ding</surname><given-names>L.</given-names></name><name><surname>Rafelski</surname><given-names>S.M.</given-names></name><name><surname>Thirstrup</surname><given-names>D.</given-names></name><etal/></person-group><article-title>CellProfiler 3.0: next-generation image processing for biology</article-title><source>PLoS Biol.</source><volume>16</volume><year>2018</year><fpage>e2005970</fpage><pub-id pub-id-type="pmid">29969450</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal" id="sref5"><person-group person-group-type="author"><name><surname>Quinn</surname><given-names>C.J.</given-names></name><name><surname>Coleman</surname><given-names>T.P.</given-names></name><name><surname>Kiyavash</surname><given-names>N.</given-names></name><name><surname>Hatsopoulos</surname><given-names>N.G.</given-names></name></person-group><article-title>Estimating the directed information to infer causal relationships in ensemble neural spike train recordings</article-title><source>J.&#x000a0;Comput. Neurosci.</source><volume>30</volume><year>2011</year><fpage>17</fpage><lpage>44</lpage><pub-id pub-id-type="pmid">20582566</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal" id="sref6"><person-group person-group-type="author"><name><surname>Schindelin</surname><given-names>J.</given-names></name><name><surname>Arganda-Carreras</surname><given-names>I.</given-names></name><name><surname>Frise</surname><given-names>E.</given-names></name><name><surname>Kaynig</surname><given-names>V.</given-names></name><name><surname>Longair</surname><given-names>M.</given-names></name><name><surname>Pietzsch</surname><given-names>T.</given-names></name><name><surname>Preibisch</surname><given-names>S.</given-names></name><name><surname>Rueden</surname><given-names>C.</given-names></name><name><surname>Saalfeld</surname><given-names>S.</given-names></name><name><surname>Schmid</surname><given-names>B.</given-names></name><etal/></person-group><article-title>Fiji: an open-source platform for biological-image analysis</article-title><source>Nat. Methods</source><volume>9</volume><year>2012</year><fpage>676</fpage><lpage>682</lpage><pub-id pub-id-type="pmid">22743772</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal" id="sref7"><person-group person-group-type="author"><name><surname>Taghdiri</surname><given-names>N.</given-names></name><name><surname>Calcagno</surname><given-names>D.M.</given-names></name><name><surname>Fu</surname><given-names>Z.</given-names></name><name><surname>Huang</surname><given-names>K.</given-names></name><name><surname>Kohler</surname><given-names>R.H.</given-names></name><name><surname>Weissleder</surname><given-names>R.</given-names></name><name><surname>Coleman</surname><given-names>T.P.</given-names></name><name><surname>King</surname><given-names>K.R.</given-names></name></person-group><article-title>Macrophage calcium reporter mice reveal immune cell communication in&#x000a0;vitro and in&#x000a0;vivo</article-title><source>Cell Rep. Methods</source><volume>1</volume><year>2021</year><fpage>100132</fpage><pub-id pub-id-type="pmid">35079727</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal" id="sref8"><person-group person-group-type="author"><name><surname>Wibral</surname><given-names>M.</given-names></name><name><surname>Pampu</surname><given-names>N.</given-names></name><name><surname>Priesemann</surname><given-names>V.</given-names></name><name><surname>Siebenh&#x000fc;hner</surname><given-names>F.</given-names></name><name><surname>Seiwert</surname><given-names>H.</given-names></name><name><surname>Lindner</surname><given-names>M.</given-names></name><name><surname>Lizier</surname><given-names>J.T.</given-names></name><name><surname>Vicente</surname><given-names>R.</given-names></name></person-group><article-title>Measuring information-transfer delays</article-title><source>PLoS One</source><volume>8</volume><year>2013</year><fpage>e55809</fpage><pub-id pub-id-type="pmid">23468850</pub-id></element-citation></ref></ref-list><sec sec-type="data-availability" id="da0010"><title>Data and code availability</title><p id="p7630">
<list list-type="simple" id="ulist0020"><list-item id="u0055"><label>&#x02022;</label><p id="p0030">This paper does not report Standardized datatypes. All data reported in this paper will be shared by the <xref rid="sec7.1" ref-type="sec">lead contact</xref> upon request.</p></list-item><list-item id="u0155"><label>&#x02022;</label><p id="p0035">All original code has been deposited at <ext-link ext-link-type="uri" xlink:href="https://github.com/Nikatag/inferring_cell_communication-_pipeline" id="intref0010">https://github.com/Nikatag/inferring_cell_communication-_pipeline</ext-link> and is publicly available.</p></list-item><list-item id="u0255"><label>&#x02022;</label><p id="p0040">Any additional information required to reanalyze the data reported in this paper is available from the <xref rid="sec7.1" ref-type="sec">lead contact</xref> upon request.</p></list-item></list>
</p></sec><ack id="ack0010"><title>Acknowledgments</title><p id="p0595">The work was funded by <funding-source id="gs1"><institution-wrap><institution-id institution-id-type="doi">10.13039/100000002</institution-id><institution>NIH</institution></institution-wrap></funding-source> R00HL129168 (K.R.K.) and DP2AR075321 (K.R.K.). We would also like to thank the UCSD Nikon Imaging Center for assistance with analysis.</p><sec id="sec9"><title>Author contributions</title><p id="p0600">N.T. and K.R.K. developed the method, performed all experiments and analysis, and wrote the manuscript.</p></sec><sec sec-type="COI-statement" id="sec10"><title>Declaration of interests</title><p id="p0605">K.R.K. is Founder, Director, on Board of Directors, and holds equity in Nightingale Labs, which has no scientific overlap with the material in this protocol.</p></sec></ack></back></article>
